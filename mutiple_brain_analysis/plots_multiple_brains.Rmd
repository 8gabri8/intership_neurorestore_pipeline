```{r}
# Read csv
df = read.csv("/run/user/1000/gvfs/smb-share:server=upcourtinenas,share=cervical/CERVICAL_ID/connectome_analysis/mutiple_brain_analysis/all_brains.csv")
df_meta = read.csv("/run/user/1000/gvfs/smb-share:server=upcourtinenas,share=cervical/CERVICAL_ID/connectome_analysis/mutiple_brain_analysis/all_brains_meta.csv")
```

# Plots

```{r}
n_roi_displayed = 20
```

```{r}
# Barplot of mean expression for first most dense regions in timepoints

region_injection = ("DR")
n_roi_displayed = 10

for (region in region_injection) {  # Iterate over the region_injection
  print(region)
  
  count_data = df
  # Select mice injected in specific region
  count_data = count_data[count_data$`Region.Injection` == region_injection,]
  # Change the shape of the df
  count_data <- count_data %>%
    select(ROI, `Cell.Density`, `Brain.ID`) %>%
    pivot_wider(names_from = `Brain.ID`, values_from = `Cell.Density`)
  
  meta_data = df_meta
  meta_data = meta_data[meta_data$`Brain.ID` %in% colnames(count_data),]
  
  timepoints = unique(df_meta$TimePoint) #Take the possbile values fo timepoints
  
  #make a plot for each time point
  for (timepoint in timepoints){
    
    temp_meta = meta_data[meta_data$TimePoint == timepoint, ] #Take only the mouse of these time point
    temp_data = count_data[, colnames(count_data) %in% c(temp_meta$`Brain.ID`,"ROI")] #Take only the relative brains
    
    #Calculate mean and std
    temp_data_no_first_col <- temp_data[, -1] #remove first column that are the nam eof the ROI
    row_means <- apply(temp_data_no_first_col, 1, mean)
    row_means[is.nan(row_means)] = 0
    row_stds <- apply(temp_data_no_first_col, 1, sd)
    row_stds[is.nan(row_stds)] = 0
                     
    #Add to df
    temp_data <- cbind(temp_data, row_mean = row_means, row_std = row_stds)
    
    # Sort the data frame by 'row_mean' in descending order
    temp_data_sorted <- temp_data[order(-temp_data$row_mean), ]
    
    #take only the first most dense regions
    temp_data_sorted = temp_data_sorted[1:n_roi_displayed,]

    print(temp_data_sorted)
    
    # Create the bar plot with error bars
    ggplot(temp_data_sorted, aes(x = ROI, y = row_mean)) +
      geom_bar(stat = "identity", fill = "lightblue", color = "blue") +
      geom_errorbar(aes(ymin = row_mean - row_std, ymax = row_mean + row_std), 
                    width = 0.2, color = "red") +
      labs(title = "Bar Plot with Error Bars", x = "Categories", y = "Values") 

    
    print(plot)
  }

  
}

```

```{r}
# Vulcano plot of 
if (!requireNamespace("DESeq2", quietly = TRUE)) {
  BiocManager::install("DESeq2")
}
if (!requireNamespace("tidyverse", quietly = TRUE)) {
  BiocManager::install("tidyverse")
}

library(DESeq2)
library(tidyverse)
library(ggplot2)

# Choose:
region_injection = "DR"
control_timepoint = "uninjured"
treatment_timepoint = "8 weeks"

#count_data: A matrix of count data (rows are genes, columns are samples).
#col_data: A DataFrame with sample information (including conditions).
#condition: The variable that differentiates between your conditions.

#prepare count_data
count_data = df
count_data = count_data[count_data$`Region.Injection` == region_injection,]
count_data <- count_data %>%
  select(ROI, Synapses, `Brain.ID`) %>%
  pivot_wider(names_from = `Brain.ID`, values_from = Synapses)
count_data = count_data[,-1]

#prepare col_data
col_data = df_meta
col_data = col_data[col_data$`Brain.ID` %in% colnames(count_data),]

# DESeq2 dataset
dds <- DESeqDataSetFromMatrix(countData = count_data,
                              colData = col_data,
                              design = ~ TimePoint)

# Run DESeq analysis
dds <- DESeq(dds)


# Get results
results <- results(dds)

# Print log fold changes and adjusted p-values
#print(results$log2FoldChange)
#print(results$padj)

# Extract results
results_df <- as.data.frame(results)

# Ensure the results contain the necessary columns
#head(results_df)

# Filter out rows with NA values if needed
results_df <- na.omit(results_df)

# Define significance thresholds
significance_threshold <- 0.05
fold_change_threshold <- 1

# Create volcano plot
volcano_plot <- ggplot(results_df, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = padj < significance_threshold & abs(log2FoldChange) > fold_change_threshold), alpha = 0.5) +
  scale_color_manual(values = c("black", "red")) +
  labs(x = "Log2 Fold Change",
       y = "-Log10 Adjusted P-Value",
       title = "Volcano Plot") +
  #theme_minimal()  +
  #xlim(-2, 2) +
  #ylim(0, 1)+
  geom_vline(xintercept = c(-fold_change_threshold, fold_change_threshold), linetype = "dashed", color = "blue") +
  geom_hline(yintercept = -log10(significance_threshold), linetype = "dashed", color = "blue")+
  theme(legend.position = "none")

# Print the plot
volcano_plot

```
